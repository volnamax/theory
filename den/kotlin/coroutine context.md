[[kotlin]]

*CoroutineContext* - это map, которая хранит set Element'ов. фактически каждое значение из контекста является контекстом.
```kotlin
Map<Key<Element>, Element>
```
![[Pasted image 20231203121805.png]]

обычно конекст определяется в скоупе или в корутин билдере

```kotlin
launch(context = context)

launch(context = Job() + Dispatchers.Main)
```

при сложении контекстов значения будут объединены, а те, что были с одинаковыми ключами будут взяты из правого

# Компоненты контекста

## Job

представляет собой выполняемую в фоне задачу

```kotlin
val job: Job = launch {...}
```

для *launch* *Job*'ом будет результат создания корутины

**жизненный цикл *Job***
![[Pasted image 20240223102211.png]]

отмена джоб приведет к рекурсивной отмене всех ее дочерних джоб.
обратно, ошибка/отмена дочерней джобы приведет к отмене родительской, та в свою очередь отменит свою родительскую и другие дочерние, и так по рекурсии.

чтобы отменялась только родительская джоба нужно использовать специальную реализацию джоб - *SupervisorJob*

**интерфейс джоб**
![[Pasted image 20240223102942.png]]

- *cancel* - отменяет выполнение джобы
- *invokeOnCompletion* - задает колбек, который будет вызван по окончанию выполнения джобы
- *join* - приостанавливает выполнения корутины и ожидает выполнения джобы
- *start* - запускает корутину, связанную с этой джоб, если она не была запущена
- *childer* - дочерние джобы
- *ensureActive* - проверяет активна ли джоба, если нет выбросит *CancellationException*

## Dispatcher

отвечает за то, на каком (каких) потоке (потоках) будет выполняться корутина

**стандартные диспатчеры**
![[Pasted image 20240223103650.png]]

- *Default* - дефолтный диспатчер, используемый корутин билдерами. стоит использовать для вычислительных операций или для переноса задач в фон. по умолчанию количество потоков в пуле соответствует количеству ядер в процессоре, но не меньше 2.
- *Main* - выполняет операции на главном потоке. по умолчанию не определен и при попытке к нему обратиться будет краш. чтобы все работало надо добавить какую-то зависимость, где есть *Main Dispatcher*, например *Coroutines Android* (можно и свою реализацию сделать, но не стоит).
- *Unconfined* - не привязан к определенному потоку. выполнение корутины происходит в том же потоке, в котором она была создана и запущена. а после вызова первой *suspend* функции корутина продолжит выполнение уже в контексте этой *suspend* функции. нужен только затем, что по умолчанию у корутины используется *Default* диспатчер, приводящих к смене потока выполнения. если нужно этого избежать, то *Unconfined* поможет.
- *IO* - предназначен для IO операций. по умолчанию количество потоков в пуле соответствует количеству ядер в процессоре, но не меньше 64. почему так много? IO операции обычно простаивают и не нагружают систему, в отличие от *Default* диспатчера. поэтому нужно много потоков, чтобы не было простоев и блокировок.

> Main.immediate используется для немедленного выполнения, если текущий поток - мейн и не занят отрисовкой кадра.  поэтому юай обновляется быстрее, т.к. обычный Main диспатчер кладет корутину в очередь на выполение