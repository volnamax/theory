[[android]]

каждый раз когда пользователь или другой компонент запрашивает запуск компонента ([[app components]]), принадлежащего приложению, андроид создает новый процесс для приложения, если он уже не запущен.

**по умолчанию, каждое приложения запускается в своем процессе.**

# Старт системы

как и в большинстве систем на базе линукс, при запуске загружается ядро и стартует *init process*. init запускает *deamon* процесс - *Zygote*.

это процесс, который инициализирует самый первый экземпляр *Dalvik VM*. он также предварительно загружает все общие классы, используемые Android application framework и различными приложениями в системе.

затем он слушает *socket interface* для создания новых *VM* для новых процессов приложений. получая запрос, он форкает себя, чтобы создать новый процесс, который получит предварительно инициализированный экземпляр *VM*.

после зиготы *init* запускает *runtime proccess*.
затем зигота форкает процесс *system server*. *system server* запускает все платформенные сервисы, например, *activity manager service* и *hardware services* в их собственном контексте.
на этом моменте все готово к запуску первого процесса приложения - *Home app*, который отображает главный экран - *Launcher app*. 

# Когда пользователь нажимает на иконку приложения

Событие клика транслируется в *startActivity(intent)* и направляется в *ActivityManagerService* через *Binder IPC (inter-process communication)*. *ActivityManagerService* делает следующее:

1. собирает информацию о *target'е* объекта *intent'а* с помощью метода *resolveIntent()* объекта *PackageManager*. по умолчанию стоят флаги *PackageManager.MATCH_DEFAULT_ONLY* и *PackageManager.GET_SHARED_LIBRARY_FILES*
2. информация о таргете интента сохраняется обратно в объект интента, чтобы не повторять это действие.
3. проверяется наличие пермишенов на вызов таргета интента с помощью *grantUriPermissionLocked()*.
4. если пермишены есть, *ActivityManagerService* проверяет тип запуска таска с помощью флагов интента: FLAG_ACTIVITY_NEW_TASK, FLAG_ACTIVITY_CLEAR_TOP, и т.д.
5. проверяется существование *ProcessRecord* для процесса. если он null, *ActivityManager* создает новый процесс для таргета.

![[Pasted image 20240216122955.png]]

# Фазы запуска процесса

## Создание процесса

*ActivityManagerService* создает новый процесс вызовом *startProcessLocked()*, который передает аргументы процессу *Zygote* через сокет соединение. *Zygote* форкает себя и вызывает *ZygoteInit.main()*, который инстанцирует объект *ActivityThread* и возвращает айди созданного процесса.

по умолчанию каждый процесс получает один поток. у главного потока есть *Looper*, который обрабатывает сообщения из очереди сообщений и вызывает *Looper.loop()* в каждой итерации его метода *run()*. *ActivityThread* запускает цикл сообщений с помощью *Looper.prepareLoop()* и *Looper.loop()* последовательно.

## Привязка приложения

далее необходимо привязать новый процесс к определенному приложению. для этого на потоке объекта вызывается *bindApplication()*. этот метод посылает сообщение *BIND_APPLICATION* в очередь сообщений. это сообщение обрабатывает *Handler* и вызывает *handleMessage()* чтобы стриггерить определенное действие сообщения - *handleBindApplication()*. этот метод вызывает *nameApplication()*, который загружает классы приложения в память.

## Запуск активити

процесс запуска происходит в *realStartActivity()*, который вызывает *scheduleLaunchActivity()* на потоке приложения. этот метод посылает сообщение *LAUNCH_ACTIVITY* в очередь сообщений. это сообщение обрабатывается методом *handleLauchActivity()*.
активити начинает свой жизненный цикл с *onCreate()*.